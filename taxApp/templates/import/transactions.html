{% extends 'taxApp/basePage.html' %}
{% block content %}
<div class="centeredGrid">
    <div class="d-flex flex-column">
        <h3 class="centeredGrid">Import Transactions</h3>
        <div class="d-flex flex-row justify-content-center">
            <button id="importTxsBtn" class="btn btn-primary importBtn m-1" data-url="{% url 'ajaxImportTransactions' %}">Get new outgoing transactions</button>
            <button class="btn btn-primary importBtn m-1" data-url="{% url 'ajaxImportIncomingTransactions' %}">NOPE Get new incoming transactions</button>
            <button class="btn btn-primary importBtn m-1" data-url="{% url 'ajaxImportIncomingInternal' %}">Get new incoming internal transactions</button>
            <button class="btn btn-primary importBtn m-1" data-url="{% url 'ajaxImportTokenTransfers' %}">Get new token transfers</button>
            <button id="getTosBtn" class="btn btn-primary importBtn m-1" data-url="{% url 'ajaxImportTxTos' %}">NOPE Get transaction "to" addresses</button>
            <button id="getFeesBtn" class="btn btn-primary importBtn m-1" data-url="{% url 'ajaxImportTxFees' %}">Get transaction fees</button>
            <button id="getFeesBtn" class="btn btn-primary importBtn m-1" data-url="{% url 'ajaxTxFeeSpends' %}">Get transaction fees AUD</button>
            <button id="getValuesBtn" class="btn btn-primary importBtn m-1" data-url="{% url 'ajaxImportTxValues' %}">Get transaction values</button>
        </div>
        <div>
            <div class="title">Process Transactions</div>
            <p>{{unprocessed}} unprocessed transactions</p>
            <div class="mt-2 d-flex flex-row justify-content-center">
                <button id="approvalssBtn" class="btn btn-primary importBtn m-1" data-url="{% url 'ajaxProcessApprovals' %}">Mark approvals as processed</button>
                <button id="dexTradesBtn" class="btn btn-primary importBtn m-1" data-url="{% url 'ajaxProcessDexTrades' %}">Process DEX trades</button>
                <button class="btn btn-primary importBtn m-1" data-url="{% url 'ajaxProcessDepositsAndSends' %}">Process deposits and sends</button>
                {% comment %} <button id="dexTradesBtn" class="btn btn-primary importBtn m-1" data-url="{% url 'ajaxProcessDexOops' %}">fix DEX oops</button> {% endcomment %}
            </div>
        </div>
        <div class="d-flex flex-row justify-content-center mt-4">
            <div class="d-flex flex-column justify-content-center">
                <div class="d-flex flex-row justify-content-center">
                    <button class="btn btn-primary m-1" data-bs-target="#txByHash" data-bs-toggle="collapse" data-action="{% url 'ajaxImportTx' %}">Import Tx By Hash</button>
                    <button class="btn btn-primary m-1" data-bs-target="#manualTtx" data-bs-toggle="collapse" data-action="{% url 'ajaxImportTx' %}">Create Token Transfer</button>
                    <button class="btn btn-primary m-1" data-bs-target="#dexTrade" data-bs-toggle="collapse">Create Dex Trade</button>
                </div>
                <div id="txByHash" class="collapse">
                    <form id="txForm" method="post" action="{% url 'ajaxImportTx' %}">
                        {% csrf_token %}
                        <div class="d-flex flex-column justify-content-center">
                            <div class="mt-1">
                                {{ txForm.hash.label_tag }}
                                {{ txForm.hash }}
                            </div>
                            <div class="mt-1">
                                {{ txForm.chain.label_tag }}
                                {{ txForm.chain }}
                            </div>
                            <div class="mt-1">
                                <button id="submitTx" data-form="txForm" type="button" class="btn btn-primary btn-submit">Submit</button>
                            </div>
                        </div>
                    </form>
                </div>
                <div id="manualTtx" class="collapse">
                    <form id="ttxForm" method="post" action="{% url 'ajaxImportTtx' %}">
                        {% csrf_token %}
                        <div class="d-flex flex-column justify-content-center">
                            <div class="mt-1">
                                {{ ttxForm.tx_hash.label_tag }}
                                {{ ttxForm.tx_hash }}
                            </div>
                            <div class="mt-1">
                                {{ ttxForm.coin_id.label_tag }}
                                    <select
                                        class="form-control coinselect"
                                        id="id_coin_id"
                                        name="coin_id"
                                        autocomplete="off"
                                        data-url={% url 'ajaxSearchCoins' %}
                                        data-addClass="form-select"
                                    >
                                    </select>
                            </div>
                            <div class="mt-1">
                                {{ ttxForm.token_address.label_tag }}
                                {{ ttxForm.token_address }}
                            </div>
                            <div class="mt-1">
                                {{ ttxForm.from_address.label_tag }}
                                {{ ttxForm.from_address }}
                            </div>
                            <div class="mt-1">
                                {{ ttxForm.to_address.label_tag }}
                                {{ ttxForm.to_address }}
                            </div>
                            <div class="mt-1">
                                {{ ttxForm.quantity.label_tag }}
                                {{ ttxForm.quantity }}
                            </div>
                            <div class="mt-1">
                                <button id="submitTtx" data-form="ttxForm" type="button" class="btn btn-primary btn-submit">Submit</button>
                            </div>
                        </div>
                    </form>
                </div>

                <div id="dexTrade" class="collapse">
                    <form id="dexTradeForm" method="post" action="{% url 'ajaxCreateDexTrade' %}">
                        {% csrf_token %}
                        <div class="d-flex flex-column justify-content-center">
                            <div class="mt-1">
                                {{ dexTradeForm.date.label_tag }}
                                {{ dexTradeForm.date }}
                            </div>
                            <div class="mt-1">
                                {{ dexTradeForm.bought_coin.label_tag }}
                                    <select
                                        class="form-control coinselect"
                                        id="id_bought_coin"
                                        name="bought_coin"
                                        autocomplete="off"
                                        data-url={% url 'ajaxSearchCoins' %}
                                        data-addClass="form-select"
                                    >
                                    </select>
                            </div>
                            <div class="mt-1">
                                {{ dexTradeForm.bought_units.label_tag }}
                                {{ dexTradeForm.bought_units }}
                            </div>
                            <div class="mt-1">
                                {{ dexTradeForm.sold_coin.label_tag }}
                                    <select
                                        class="form-control coinselect"
                                        id="id_sold_coin"
                                        name="sold_coin"
                                        autocomplete="off"
                                        data-url={% url 'ajaxSearchCoins' %}
                                        data-addClass="form-select"
                                    >
                                    </select>
                            </div>
                            <div class="mt-1">
                                {{ dexTradeForm.sold_units.label_tag }}
                                {{ dexTradeForm.sold_units }}
                            </div>
                            <div class="mt-1">
                                {{ dexTradeForm.fee.label_tag }}
                                {{ dexTradeForm.fee }}
                            </div>
                            <div class="mt-1">
                                {{ dexTradeForm.fee_coin.label_tag }}
                                    <select
                                        class="form-control coinselect"
                                        id="id_fee_coin"
                                        name="fee_coin"
                                        autocomplete="off"
                                        data-url={% url 'ajaxSearchCoins' %}
                                        data-addClass="form-select"
                                    >
                                    </select>
                            </div>
                            <div class="mt-1">
                                {{ dexTradeForm.note.label_tag }}
                                {{ dexTradeForm.note }}
                            </div>
                            <div class="mt-1">
                                <button data-form="dexTradeForm" type="button" class="btn btn-primary btn-submit">Submit</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock content %}

{% block inlineJS %}
    <script>
        $(document).ready(function(){

            let poller;

            async function poll(){
                let res = await fetch("{% url 'ajaxPollTxFees' %}");
                let response = await res.json();
                console.log(response)
                let tmpl;
                if (response.ok){
                    if (response.status == "running"){
                        let prog = response.progress;
                        tmpl = `
                            <div>txFees are being processed...</div>
                            <div class="progress">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" aria-valuenow="${prog}" aria-valuemin="0" aria-valuemax="100" style="width: ${prog}%">${prog}%</div>
                            </div>
                        `
                    } else if (response.status != "running"){
                        tmpl = `<div>${response.msg}</div>`
                        clearInterval(poller);
                    }
                } else {
                    tmpl = `<div>${response.msg}</div>`
                }
                $("#messageContent").html(tmpl)
            }

            {% if running %}
                poll()
                poller = setInterval(poll, 5000);
            {% endif %}

            $(".coinselect").autoComplete()

            $(".importBtn").click(async function() {
                let url = $(this).data('url')
                let resp = await fetch(url)
                let res = await resp.json()

                if (res.msg){
                    $("#messageContent").text(res.msg);
                    $("#message").slideDown();
                }
                if (res.running){
                    poller = setInterval(poll, 5000);
                }
            })


            $(".btn-submit").click(async function(event) {
                event.preventDefault();
                $("#message").slideUp();
                let form = $(this).data('form')
                let res = await postForm($(`#${form}`))
                console.log(res)
                if (res.msg){
                    $("#messageContent").text(res.msg);
                    $("#message").slideDown();
                }
            })
        });
    </script>
{% endblock inlineJS %}

