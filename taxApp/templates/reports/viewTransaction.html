{% extends 'taxApp/basePage.html' %}
{% load token_utils %}
{% block content %}
    <div class="centeredGrid">
        <div class="d-flex flex-column">
            <h3 class="centeredGrid">Transaction</h3>
            <table class="table table-bordered table-hover table-responsive-md">
                <tbody>
                    <tr>
                        <th>ID</th>
                        <td>{{tx.id}}</td>
                    </tr>
                    <tr>
                        <th>From</th>
                        <td>{{tx.fromAddr.address}}</td>
                    </tr>
                    <tr>
                        <th>Date</th>
                        <td>{{tx.date|date:'d/m/Y'}}</td>
                    </tr>
                    <tr>
                        <th>Chain</th>
                        <td>{{tx.chain.name}}</td>
                    </tr>
                    <tr>
                        <th>Hash</th>
                        <td><a href="{{tx.explorerUrl}}">{{tx.hash}}</a></td>
                    </tr>
                    <tr>
                        <th>to</th>
                        <td>{{tx.toAddr.address}}</td>
                    </tr>
                    <tr>
                        <th>Value</th>
                        <td>{{tx.value|floatformat:"-4g"}} {{tx.feeCoin.symbol}}</td>
                    </tr>
                    <tr>
                        <th>Fee</th>
                        <td>{{tx.fee|floatformat:"-4g"}} {{tx.feeCoin.symbol}}</td>
                    </tr>
                    <tr>
                        <th>Fee AUD</th>
                        <td>${{tx.feeAUD|floatformat:"-2"}}</td>
                    </tr>
                    <tr>
                        <th>Out</th>
                        <td>
                            {% for d in tx.internaltransaction_set.all %}
                                {% if d.fromAddr.user == user %}
                                    <div>{{d.value|floatformat:"-4g"}} {{d.coin.symbol}}</div>
                                {% endif %}
                            {% endfor %}
                            {% for d in tx.tokentransfer_set.all %}
                                {% if d.fromAddr.user == user %}
                                    <div>{{d.value|floatformat:"-4g"}} {{d.coin.symbol}}</div>
                                {% endif %}
                            {% endfor %}
                        </td>
                    </tr>
                    <tr>
                        <th>In</th>
                        <td>
                            {% for d in tx.internaltransaction_set.all %}
                                {% if d.toAddr.user == user %}
                                    <div>{{d.value|floatformat:"-4g"}} {{d.coin.symbol}}</div>
                                {% endif %}
                            {% endfor %}
                            {% for d in tx.tokentransfer_set.all %}
                                {% if d.toAddr.user == user %}
                                    <div>{{d.value|floatformat:"-4g"}} {{d.coin.symbol}}</div>
                                {% endif %}
                            {% endfor %}
                        </td>
                    </tr>
                    <tr>
                        <th>Processed</th>
                        <td>{% if tx.processed %}<i class="fas fa-check"></i>{% endif %}</td>
                    </tr>
                </tbody>
            </table>

            <div class="card card-lg">
                <div class="d-flex flex-column">
                    <div class="centeredGrid"><b>Process Transaction</b></div>
                        {% if tx.processed %}
                            <div class="mt-2 d-flex flex-row justify-content-center">
                                <p>Processed</p>
                            </div>
                        {% else %} 
                            <div class="mt-2 d-flex flex-row justify-content-center">
                                <button class="btn btn-primary processBtn m-1" data-url="{% url 'ajaxMarkAsProcessed' tx.id %}">Mark as Processed</button>  
                                <button class="btn btn-primary processBtn m-1" data-url="{% url 'ajaxProcessBridgeSend' tx.id %}">As Bridge Send</button>  
                            </div>
                            <div class="mt-2 d-flex flex-row justify-content-center">
                                <button class="btn btn-primary processBtn m-1" data-url="{% url 'ajaxProcessVaultDeposit' tx.id %}">As Vault Deposit</button>  
                                <button class="btn btn-primary processBtn m-1" data-url="{% url 'ajaxProcessVaultIncome' tx.id %}">As Vault Income</button>   
                                <button class="btn btn-primary processBtn m-1" data-url="{% url 'ajaxProcessVaultWithdrawal' tx.id %}">As Vault Withdrawal</button>  
                                <button class="btn btn-primary processBtn m-1" data-url="{% url 'ajaxProcessVaultRestake' tx.id %}">As Vault Restake</button> 
                            </div> 
                            <div class="mt-2 d-flex flex-row justify-content-center">
                                <button type="button" class="btn btn-primary m-1" data-bs-target="#migrate" data-bs-toggle="collapse">As Vault Migration</button> 
                                <button type="button" class="btn btn-primary m-1" data-bs-target="#withdrawAndTrade" data-bs-toggle="collapse">As Vault Withdraw and Trade</button> 
                            </div>

                            <div id="migrate" class="collapse mt-2">
                                <form id="migrateForm" method="post" action="{% url 'ajaxProcessVaultMigrate' tx.id %}">                                                    
                                    {% csrf_token %}                                                    
                                    <div class="d-flex flex-column justify-content-center">
                                        <div class="mt-1">
                                            <label>Old Vault Address:
                                                <input class="form-control" type="text" name="oldAddress">
                                            </label>
                                        </div>
                                        <div class="mt-1">
                                            <label>New Vault Address:
                                                <input class="form-control" type="text" name="newAddress" value="{{tx.toAddr.address}}">
                                            </label>
                                        </div>
                                        <div class="mt-1">
                                            <label>Amount:
                                                <input class="form-control" type="text" name="amount">
                                            </label>
                                        </div>
                                        <div class="mt-1">
                                            <label>Denomination:
                                                <select class="form-select" type="text" name="denomination">
                                                    <option value="wei" selected>Wei</option>
                                                    <option value"ether">Ether</option>
                                                </select>
                                            </label>
                                        </div>
                                        <div class="mt-1">
                                            <label>Coin
                                                <select 
                                                    class="form-control coinSelect" 
                                                    name="coin" 
                                                    autoconplete="off" 
                                                    data-url="/ajax/coins/search/"
                                                    data-addClass="form-select"
                                                >
                                                </select>
                                            </label>
                                        </div>
                                        <div class="mt-1">
                                            <button id="submitMigrate" data-form="migrateForm" type="button" class="btn btn-primary btn-submit">Submit</button>
                                        </div>
                                    </div>      
                                    
                                </form>
                            </div>

                            <div id="withdrawAndTrade" class="collapse mt-2">
                                <form id="withdrawAndTradeForm" method="post" action="{% url 'ajaxProcessVaultWithdrawAndTrade' tx.id %}">                                                    
                                    {% csrf_token %}                                                    
                                    <div class="d-flex flex-column justify-content-center">
                                        <div class="mt-1">
                                            <label>Vault Address:
                                                <input class="form-control" type="text" name="address">
                                            </label>
                                        </div>
                                        <div class="mt-1">
                                            <label>Amount withdrawn:
                                                <input class="form-control" type="text" name="withdrawAmount">
                                            </label>
                                        </div>
                                        <div class="mt-1">
                                            <label>Denomination:
                                                <select class="form-select" type="text" name="withdrawDenomination">
                                                    <option value="wei" selected>Wei</option>
                                                    <option value"ether">Ether</option>
                                                </select>
                                            </label>
                                        </div>
                                        <div class="mt-1">
                                            <label>Coin
                                                <select 
                                                    class="form-control coinSelect" 
                                                    name="withdrawCoin" 
                                                    autoconplete="off" 
                                                    data-url="/ajax/coins/search/"
                                                    data-addClass="form-select"
                                                >
                                                </select>
                                            </label>
                                        </div>
                                        <div class="mt-1">
                                            <label>Amount received:
                                                <input class="form-control" type="text" name="receiveAmount">
                                            </label>
                                        </div>
                                        <div class="mt-1">
                                            <label>Denomination:
                                                <select class="form-select" type="text" name="receiveDenomination">
                                                    <option value="wei" selected>Wei</option>
                                                    <option value"ether">Ether</option>
                                                </select>
                                            </label>
                                        </div>
                                        <div class="mt-1">
                                            <label>Coin
                                                <select 
                                                    class="form-control coinSelect" 
                                                    name="receiveCoin" 
                                                    autoconplete="off" 
                                                    data-url="/ajax/coins/search/"
                                                    data-addClass="form-select"
                                                >
                                                </select>
                                            </label>
                                        </div>
                                        <div class="mt-1">
                                            <button data-form="withdrawAndTradeForm" type="button" class="btn btn-primary btn-submit">Submit</button>
                                        </div>
                                    </div>      
                                    
                                </form>
                            </div>

                        {% endif %}
                    <div class="mt-2 d-flex flex-row justify-content-center">
                        <a href="{% url 'nextUnprocessed' tx.id 'new' %}" class="btn btn-primary m-1"><i class="fas fa-angle-left"></i></a>
                        <a href="{% url 'nextUnprocessed' tx.id 'old' %}" class="btn btn-primary m-1"><i class="fas fa-angle-right"></i></a>
                    </div>
                </div>
            </div>

            <div class="card card-lg">
                <div class="d-flex flex-column">
                    <div class="centeredGrid"><b>Input</b></div>
                    {{inputs|pprint}}
                </div>
            </div>

            <div class="card card-lg">
                <div class="d-flex flex-column">
                    <div class="centeredGrid"><b>Logs</b></div>
                    {% for log in logs %}
                        <div class="mt-2">
                            {% comment %} {{log}} {% endcomment %}
                            {{log.logIndex}} {{log.event}} {{log.address|get_token}}<br>
                            {% for k, v in log.args.items %}
                                {{k}}: {{v}}<br>
                            {% endfor %}
                        </div>
                    {% endfor %}
                </div>
            </div>

            <div class="card card-lg">
                <div class="d-flex flex-column">
                    <div class="centeredGrid"><b>full transaction</b></div>
                    {% for k,v in txDetails.items %}
                    <div class="mt-2">{{k}}: {{v}}</div>
                    {% endfor %}
                    {% comment %} {{receipt.result|pprint}} {% endcomment %}
                </div>
            </div>

            <div class="card card-lg">
                <div class="d-flex flex-column">
                    <div class="centeredGrid"><b>full receipt</b></div>
                    {% for k,v in receipt.result.items %}
                    <div class="mt-2">{{k}}: {{v}}</div>
                    {% endfor %}
                    {% comment %} {{receipt.result|pprint}} {% endcomment %}
                </div>
            </div>
        </div>
    </div>

{% endblock content %}

{% block inlineJS %}
    <script>
        $(document).ready(function(){
            $(".coinSelect").autoComplete();
            $(".processBtn").click(async function() {
                let url = $(this).data('url')
                let resp = await fetch(url)
                let res = await resp.json()

                if (res.msg){
                    $("#messageContent").text(res.msg);
                    $("#message").slideDown();
                }
            })

            $(".btn-submit").click(async function(event) {
                event.preventDefault();
                $("#message").slideUp();
                let form = $(this).data('form')
                let res = await postForm($(`#${form}`))
                if (res.msg){
                    $("#messageContent").text(res.msg);
                    $("#message").slideDown();
                }
            })
        });
    </script>
{% endblock inlineJS %}