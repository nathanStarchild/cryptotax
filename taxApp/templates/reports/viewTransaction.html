{% extends 'taxApp/basePage.html' %}
{% load token_utils %}
{% block content %}
    <div class="centeredGrid">
        <div class="d-flex flex-column">
            <h3 class="centeredGrid">Transaction</h3>
            <table class="table table-bordered table-hover table-responsive-md">
                <tbody>
                    <tr>
                        <th>ID</th>
                        <td>{{tx.id}}</td>
                    </tr>
                    <tr>
                        <th>From</th>
                        <td>{{tx.fromAddr.address}}</td>
                    </tr>
                    <tr>
                        <th>Date</th>
                        <td>{{tx.date|date:'d/m/Y'}}</td>
                    </tr>
                    <tr>
                        <th>Chain</th>
                        <td>{{tx.chain.name}}</td>
                    </tr>
                    <tr>
                        <th>Hash</th>
                        <td><a href="{{tx.explorerUrl}}">{{tx.hash}}</a></td>
                    </tr>
                    <tr>
                        <th>to</th>
                        <td>{{tx.toAddr.address}}</td>
                    </tr>
                    <tr>
                        <th>Value</th>
                        <td>{{tx.value|floatformat:"-4g"}} {{tx.feeCoin.symbol}}</td>
                    </tr>
                    <tr>
                        <th>Fee</th>
                        <td>{{tx.fee|floatformat:"-4g"}} {{tx.feeCoin.symbol}}</td>
                    </tr>
                    <tr>
                        <th>Fee AUD</th>
                        <td>${{tx.feeAUD|floatformat:"-2"}}</td>
                    </tr>
                    <tr>
                        <th>Out</th>
                        <td>
                            {% for d in tx.internaltransaction_set.all %}
                                {% if d.fromAddr.user == user %}
                                    <div>{{d.value|floatformat:"-4g"}} {{d.coin.symbol}}</div>
                                {% endif %}
                            {% endfor %}
                            {% for d in tx.tokentransfer_set.all %}
                                {% if d.fromAddr.user == user %}
                                    <div>
                                        {{d.value|floatformat:"-4g"}} {{d.token.coin.symbol}}
                                        {% if d.token.coin.name == "spam" %}
                                            <button type="button" class="btn btn-primary btn-notspam processBtn" data-url="{% url 'ajaxTokenNotSpam' d.token.id %}">
                                                Not Spam
                                            </button>
                                        {% endif %}
                                    </div>
                                {% endif %}
                            {% endfor %}
                        </td>
                    </tr>
                    <tr>
                        <th>In</th>
                        <td>
                            {% for d in tx.internaltransaction_set.all %}
                                {% if d.toAddr.user == user %}
                                    <div>{{d.value|floatformat:"-4g"}} {{d.coin.symbol}}</div>
                                {% endif %}
                            {% endfor %}
                            {% for d in tx.tokentransfer_set.all %}
                                {% if d.toAddr.user == user %}
                                    <div>
                                        {{d.value|floatformat:"-4g"}} {{d.token.coin.symbol}}
                                        {% if d.token.coin.id == 11160 %}
                                            <button type="button" class="btn btn-primary btn-notspam processBtn" data-url="{% url 'ajaxTokenNotSpam' d.token.id %}">
                                                Not Spam
                                            </button>
                                        {% endif %}

                                    </div>
                                {% endif %}
                            {% endfor %}
                        </td>
                    </tr>
                    <tr>
                        <th>Processed</th>
                        <td>{% if tx.processed %}<i class="fas fa-check"></i>{% endif %}</td>
                    </tr>
                    <tr>
                        <th>Note</th>
                        <td>{% if tx.note %}{{ tx.note }}{% endif %}</td>
                    </tr>
                </tbody>
            </table>

            <div class="card card-lg">
                <div class="d-flex flex-column">
                    <div class="centeredGrid"><b>Process Transaction</b></div>
                        {% if tx.processed %}
                            <div class="mt-2 d-flex flex-row justify-content-center">
                                <p>Processed</p>
                            </div>
                        {% else %} 
                            <div class="mt-2 d-flex flex-row justify-content-center">
                                <button class="btn btn-primary processBtn m-1" data-url="{% url 'ajaxMarkAsProcessed' tx.id %}">Mark as Processed</button>  
                                <button class="btn btn-primary btn-outgoing m-1" data-bs-target="#selectOutgoing" data-bs-toggle="collapse" data-action="{% url 'ajaxProcessBridgeSend' tx.id %}">As Bridge Send</button>  
                                <button class="btn btn-primary processBtn m-1" data-url="{% url 'ajaxProcessDexTrade' tx.id %}">As Dex Trade</button>
                                <button class="btn btn-primary btn-cowSwap m-1">As CoW Swap</button>  
                                <button class="btn btn-primary processBtn m-1" data-url="{% url 'ajaxProcessHarvest' tx.id %}">As Harvest()</button>  
                                <button type="button" class="btn btn-primary btn-incoming m-1" data-bs-target="#selectIncoming" data-bs-toggle="collapse" data-action="{% url 'ajaxProcessIncome' %}">As income</button> 
                                <button type="button" class="btn btn-primary btn-incoming m-1" data-bs-target="#selectIncoming" data-bs-toggle="collapse" data-action="{% url 'ajaxProcessInitialAirdrop' %}">As Airdrop at launch</button>
                                <button class="btn btn-primary btn-form m-1" data-form="#addNoteForm" data-bs-target="#addNote" data-bs-toggle="collapse" data-action="{% url 'ajaxProcessSpend' tx.id %}">As Spend</button>
                                <button class="btn btn-primary processBtn m-1" data-url="{% url 'ajaxProcessFailedTx' tx.id %}">As Failed</button>  
                            </div>
                            <div class="mt-2 d-flex flex-row justify-content-center">
                                <button class="btn btn-primary processBtn m-1" data-url="{% url 'ajaxProcessVaultDeposit' tx.id %}">As Vault Deposit</button>
                                <button class="btn btn-primary btn-incoming m-1" data-bs-target="#selectIncoming" data-bs-toggle="collapse" data-action="{% url 'ajaxProcessVaultIncome' tx.id %}">As Vault Income</button>
                                <button type="button" class="btn btn-primary btn-incoming m-1" data-bs-target="#selectIncoming" data-bs-toggle="collapse" data-action="{% url 'ajaxProcessVaultDepositAndIncome' tx.id %}">As Vault Income and Deposit</button> 
                                <button class="btn btn-primary btn-incoming m-1" data-bs-target="#selectIncoming" data-bs-toggle="collapse" data-action="{% url 'ajaxProcessVaultWithdrawal' tx.id %}">As Vault Withdrawal</button>
                                <button class="btn btn-primary processBtn m-1" data-url="{% url 'ajaxProcessVaultRestake' tx.id %}">As Vault Restake</button> 
                            </div> 
                            <div class="mt-2 d-flex flex-row justify-content-center">
                                <button type="button" class="btn btn-primary m-1" data-bs-target="#migrate" data-bs-toggle="collapse">As Vault Migration</button> 
                                <button type="button" class="btn btn-primary m-1" data-bs-target="#withdrawAndTrade" data-bs-toggle="collapse">As Vault Withdraw and Trade</button> 
                            </div>

                            <div class="mt-2 d-flex flex-row justify-content-center">
                                <button class="btn btn-primary matchingBtn m-1" data-url="{% url 'ajaxFindMatchingTxs' tx.id %}">Find Matching Txs</button>  
                            </div>


                            <div id="addNote" class="collapse mt-2">
                                <form id="addNoteForm" method="post" action="tmp">
                                    {% csrf_token %}
                                    <div class="d-flex flex-column justify-content-center">
                                        <div class="mt-1">
                                            <label>Note:
                                                <input type="text" class="form-control" name="note">
                                            </label>
                                        </div>
                                        <div class="mt-1">
                                            <button id="submitNote" data-form="addNoteForm" type="button" class="btn btn-primary btn-submit">Submit</button>
                                        </div>
                                    </div>

                                </form>
                            </div>

                            <div id="selectIncoming" class="collapse mt-2">
                                <form id="incomingForm" method="post" action="tmp">                                                    
                                    {% csrf_token %}                                                    
                                    <div class="d-flex flex-column justify-content-center">
                                        <div class="mt-1">
                                            <label>Which incoming token:
                                                <select class="form-select" name="ttx">
                                                    {% for d in tx.tokentransfer_set.all %}
                                                        {% if d.toAddr.user == user %}
                                                            <option value="{{d.id}}">{{d.value|floatformat:"-4g"}} {{d.token.coin.symbol}}</option>
                                                        {% endif %}
                                                    {% endfor %}
                                                </select>
                                            </label>
                                        </div>
                                        <div class="mt-1">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="subtractFee" value="" id="flexCheckDefault">
                                                <label class="form-check-label" for="flexCheckDefault">
                                                    Subtract Transaction Fee
                                                </label>
                                          </div>
                                        </div>
                                        <div class="mt-1">
                                            <label>Note:
                                                <input type="text" class="form-control" name="note">
                                            </label>
                                        </div>
                                        <div class="mt-1">
                                            <button id="submitIncoming" data-form="incomingForm" type="button" class="btn btn-primary btn-submit">Submit</button>
                                        </div>
                                    </div>      
                                    
                                </form>
                            </div>

                            <div id="selectOutgoing" class="collapse mt-2">
                                <form id="outgoingForm" method="post" action="tmp">                                                    
                                    {% csrf_token %}                                                    
                                    <div class="d-flex flex-column justify-content-center">
                                        <div class="mt-1">
                                            <label>Which outgoing token:
                                                <select class="form-select" name="ttx">
                                                    {% for d in tx.tokentransfer_set.all %}
                                                        {% if d.fromAddr.user == user %}
                                                            <option value="{{d.id}}">{{d.value|floatformat:"-4g"}} {{d.token.coin.symbol}}</option>
                                                        {% endif %}
                                                    {% endfor %}
                                                </select>
                                            </label>
                                        </div>
                                        <div class="mt-1">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="subtractFee" value="" id="flexCheckDefault">
                                                <label class="form-check-label" for="flexCheckDefault">
                                                    Subtract Transaction Fee
                                                </label>
                                          </div>
                                        </div>
                                        <div class="mt-1">
                                            <label>Note:
                                                <input type="text" class="form-control" name="note">
                                            </label>
                                        </div>
                                        <div class="mt-1">
                                            <button id="submitOutgoing" data-form="outgoingForm" type="button" class="btn btn-primary btn-submit">Submit</button>
                                        </div>
                                    </div>      
                                    
                                </form>
                            </div>

                            <div id="income" class="collapse mt-2">
                                <form id="incomeForm" method="post" action="{% url 'ajaxProcessIncome' %}">                                                    
                                    {% csrf_token %}                                                    
                                    <div class="d-flex flex-column justify-content-center">
                                        <div class="mt-1">
                                            <label>Which incoming token:
                                                <select class="form-select" name="ttx">
                                                    {% for d in tx.tokentransfer_set.all %}
                                                        {% if d.toAddr.user == user %}
                                                            <option value="{{d.id}}">{{d.value|floatformat:"-4g"}} {{d.token.coin.symbol}}</option>
                                                        {% endif %}
                                                    {% endfor %}
                                                </select>
                                            </label>
                                        </div>
                                        <div class="mt-1">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="subtractFee" value="" id="flexCheckDefault">
                                                <label class="form-check-label" for="flexCheckDefault">
                                                    Subtract Transaction Fee
                                                </label>
                                          </div>
                                        </div>
                                        <div class="mt-1">
                                            <label>Note:
                                                <input type="text" class="form-control" name="note">
                                            </label>
                                        </div>
                                        <div class="mt-1">
                                            <button id="submitIncome" data-form="incomeForm" type="button" class="btn btn-primary btn-submit">Submit</button>
                                        </div>
                                    </div>      
                                    
                                </form>
                            </div>

                            <div id="airdrop" class="collapse mt-2">
                                <form id="airdropForm" method="post" action="{% url 'ajaxProcessInitialAirdrop' %}">                                                    
                                    {% csrf_token %}                                                    
                                    <div class="d-flex flex-column justify-content-center">
                                        <div class="mt-1">
                                            <label>Which incoming token:
                                                <select class="form-select" name="ttx">
                                                    {% for d in tx.tokentransfer_set.all %}
                                                        {% if d.toAddr.user == user %}
                                                            <option value="{{d.id}}">{{d.value|floatformat:"-4g"}} {{d.token.coin.symbol}}</option>
                                                        {% endif %}
                                                    {% endfor %}
                                                </select>
                                            </label>
                                        </div>
                                        <div class="mt-1">
                                            <button id="submitAirdrop" data-form="airdropForm" type="button" class="btn btn-primary btn-submit">Submit</button>
                                        </div>
                                    </div>      
                                    
                                </form>
                            </div>

                            <div id="migrate" class="collapse mt-2">
                                <form id="migrateForm" method="post" action="{% url 'ajaxProcessVaultMigrate' tx.id %}">                                                    
                                    {% csrf_token %}                                                    
                                    <div class="d-flex flex-column justify-content-center">
                                        <div class="mt-1">
                                            <label>Old Vault Address:
                                                <input class="form-control" type="text" name="oldAddress">
                                            </label>
                                        </div>
                                        <div class="mt-1">
                                            <label>New Vault Address:
                                                <input class="form-control" type="text" name="newAddress" value="{{tx.toAddr.address}}">
                                            </label>
                                        </div>
                                        <div class="mt-1">
                                            <label>Amount:
                                                <input class="form-control" type="text" name="amount">
                                            </label>
                                        </div>
                                        <div class="mt-1">
                                            <label>Denomination:
                                                <select class="form-select" type="text" name="denomination">
                                                    <option value="wei" selected>Wei</option>
                                                    <option value"ether">Ether</option>
                                                </select>
                                            </label>
                                        </div>
                                        <div class="mt-1">
                                            <label>Coin
                                                <select 
                                                    class="form-control coinSelect" 
                                                    name="coin" 
                                                    autoconplete="off" 
                                                    data-url="/ajax/coins/search/"
                                                    data-addClass="form-select"
                                                >
                                                </select>
                                            </label>
                                        </div>
                                        <div class="mt-1">
                                            <button id="submitMigrate" data-form="migrateForm" type="button" class="btn btn-primary btn-submit">Submit</button>
                                        </div>
                                    </div>      
                                    
                                </form>
                            </div>

                            <div id="withdrawAndTrade" class="collapse mt-2">
                                <form id="withdrawAndTradeForm" method="post" action="{% url 'ajaxProcessVaultWithdrawAndTrade' tx.id %}">                                                    
                                    {% csrf_token %}                                                    
                                    <div class="d-flex flex-column justify-content-center">
                                        <div class="mt-1">
                                            <label>Vault Address:
                                                <input class="form-control" type="text" name="address">
                                            </label>
                                        </div>
                                        <div class="mt-1">
                                            <label>Amount withdrawn:
                                                <input class="form-control" type="text" name="withdrawAmount">
                                            </label>
                                        </div>
                                        <div class="mt-1">
                                            <label>Denomination:
                                                <select class="form-select" type="text" name="withdrawDenomination">
                                                    <option value="wei" selected>Wei</option>
                                                    <option value"ether">Ether</option>
                                                </select>
                                            </label>
                                        </div>
                                        <div class="mt-1">
                                            <label>Coin
                                                <select 
                                                    class="form-control coinSelect" 
                                                    name="withdrawCoin" 
                                                    autoconplete="off" 
                                                    data-url="/ajax/coins/search/"
                                                    data-addClass="form-select"
                                                >
                                                </select>
                                            </label>
                                        </div>
                                        <div class="mt-1">
                                            <label>Amount received:
                                                <input class="form-control" type="text" name="receiveAmount">
                                            </label>
                                        </div>
                                        <div class="mt-1">
                                            <label>Denomination:
                                                <select class="form-select" type="text" name="receiveDenomination">
                                                    <option value="wei" selected>Wei</option>
                                                    <option value"ether">Ether</option>
                                                </select>
                                            </label>
                                        </div>
                                        <div class="mt-1">
                                            <label>Coin
                                                <select 
                                                    class="form-control coinSelect" 
                                                    name="receiveCoin" 
                                                    autoconplete="off" 
                                                    data-url="/ajax/coins/search/"
                                                    data-addClass="form-select"
                                                >
                                                </select>
                                            </label>
                                        </div>
                                        <div class="mt-1">
                                            <button data-form="withdrawAndTradeForm" type="button" class="btn btn-primary btn-submit">Submit</button>
                                        </div>
                                    </div>      
                                    
                                </form>
                            </div>

                        {% endif %}
                    <div class="mt-2 d-flex flex-row justify-content-center">
                        <a href="{% url 'nextUnprocessed' tx.id 'new' %}" class="btn btn-primary m-1"><i class="fas fa-angle-left"></i></a>
                        <a href="{% url 'nextUnprocessed' tx.id 'old' %}" class="btn btn-primary m-1"><i class="fas fa-angle-right"></i></a>
                    </div>
                </div>
            </div>

            <div class="card card-lg">
                <div class="d-flex flex-column">
                    <div class="centeredGrid"><b>Input</b></div>
                    {{inputs|pprint}}
                </div>
            </div>

            <div class="card card-lg">
                <div class="d-flex flex-column">
                    <div class="centeredGrid"><b>Logs</b></div>
                    {% for log in logs %}
                        <div class="mt-2">
                            {% comment %} {{log}} {% endcomment %}
                            {{log.logIndex}} {{log.event}} {{log.address|get_token}}<br>
                            {% for k, v in log.args.items %}
                                {{k}}: {{v}}<br>
                            {% endfor %}
                        </div>
                    {% endfor %}
                </div>
            </div>

            <div class="card card-lg">
                <div class="d-flex flex-column">
                    <div class="centeredGrid"><b>full transaction</b></div>
                    {% for k,v in txDetails.items %}
                    <div class="mt-2">{{k}}: {{v}}</div>
                    {% endfor %}
                    {% comment %} {{receipt.result|pprint}} {% endcomment %}
                </div>
            </div>

            <div class="card card-lg">
                <div class="d-flex flex-column">
                    <div class="centeredGrid"><b>full receipt</b></div>
                    {% for k,v in receipt.result.items %}
                    <div class="mt-2">{{k}}: {{v}}</div>
                    {% endfor %}
                    {% comment %} {{receipt.result|pprint}} {% endcomment %}
                </div>
            </div>
        </div>
    </div>

{% endblock content %}

{% block inlineJS %}
    <script>
        $(document).ready(function(){
            matchingIds = []
            $(".coinSelect").autoComplete();
            $(".processBtn").click(async function() {
                $("#message").slideUp();
                let url = $(this).data('url')
                if (matchingIds.length > 0){
                    for (const txId of matchingIds) {
                        $("#message").slideUp();
                        let newUrl = url.replace("/{{tx.id}}/", `/${txId}/`)
                        let resp = await fetch(newUrl)
                        let res = await resp.json()
        
                        if (res.msg){
                            $("#messageContent").text(res.msg);
                            $("#message").slideDown();
                        }
                    }
                    return
                }
                let resp = await fetch(url)
                let res = await resp.json()

                if (res.msg){
                    $("#messageContent").text(res.msg);
                    $("#message").slideDown();
                }
            })

            $(".btn-submit").click(async function(event) {
                event.preventDefault();
                $("#message").slideUp();
                let form = $(this).data('form')
                let res = await postForm($(`#${form}`))
                console.log(res)
                if (res.msg){
                    $("#messageContent").text(res.msg);
                    $("#message").slideDown();
                }
            })

            $(".btn-cowSwap").click(async function() {
                let url = "{% url 'ajaxNearestIncomingTransfer' tx.id %}"
                $("#message").slideUp();
                let resp = await fetch(url)
                let res = await resp.json()
                if (res.ok){
                    if (confirm(res.msg)){
                        let url2 = '{% url "ajaxProcessCoWSwap" tx.id "!ttx" %}'.replace('!ttx', res.ttxId)
                        let resp2 = await fetch(url2)
                        let res2 = await resp2.json()
                        if (res2.msg){
                            $("#messageContent").text(res2.msg);
                            $("#message").slideDown();
                        }
                    }
                }
            })

            $(".btn-form").click(function() {
                $($(this).data("form")).attr("action", $(this).data("action"))
            })

            $(".btn-incoming").click(function() {
                $("#incomingForm").attr("action", $(this).data("action"))
            })

            $(".btn-outgoing").click(function() {
                $("#outgoingForm").attr("action", $(this).data("action"))
            })


            $(".matchingBtn").click(async function() {
                console.log("aha")
                let url = $(this).data('url')
                let resp = await fetch(url)
                let res = await resp.json()
                console.log(res)

                if (res.msg){
                    $("#messageContent").text(res.msg);
                    $("#message").slideDown();
                }
                if (res.ids) {
                    matchingIds = res.ids
                    console.log(matchingIds)
                }
            })
        });
    </script>
{% endblock inlineJS %}